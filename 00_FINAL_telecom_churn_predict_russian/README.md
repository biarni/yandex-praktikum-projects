## Отчет по результатам исследовательской работы

### Введение

Управление клиентской базой имеет огромное значение для компании, оказывающей услуги в области телекоммуникаций.  
Очевидно, что отток клиентов негативно влияет на выручку компании. Кроме того, влияние оттока клиентов на прибыль компании еще более негативное, поскольку постоянные затраты (не зависящие от числа клиентов) в технологической отрасли, как правило, высоки. Если при снижении числа клиентов одновременно сокращается и выручка и переменные затраты, то постоянные затраты остаются неизменными, их доля в себестоимости и негативное влияние на прибыль возрастает.   

Таким образом, в ситуации существенного оттока клиентов прибыль снижается быстрее, чем выручка.

Согласно данным, предоставленным заказчиком, в то время как **отток клиентов за 4 последних месяца составил 1869 клиентов** (это весь отток клиентов в предоставленных данных или 26,5% от общего числа клиентов на момент среза данных), **приток новых составил только 464 клиента.**

**Цель проекта:**  

1. Провести анализ данных и разработать модель машинного обучения для определения клиентов, склонных уйти из компании в ближайшее время (задача классификации), что позволит предложить ему специальные условия и избежать падения клиентской базы, выручки и прибыли компании.
2. Предложить механизм расчета влияния предложения скидок конкретным клиентам, вероятности ухода которых предсказала модель, на выручку компании с целью ее максимизации.
3. Составить портрет клиента, склонного к уходу, для дальнейшего маркетингового и продуктового анализа.

**План работ (этапы выполнения):**
1. Обзор данных и их предварительный анализ.  
2. Подготовка данных для исследовательского анализа.  
3. Исследовательский анализ данных с выявлением факторов, могущих влиять на отток клиентов.  
4. Разработка модели, подбор гиперпараметров на тренировочной выборке с использованием кросс-валидации.  
5. Тестирование модели на тестовой выборке.  
6. Интерпретация результатов.  

Цели проекта были достигнуты в соответствии с планом работы.  
В ходе выполнения проекта возникли вопросы с заполнением пропущенных значений: при заполнении отсутствующих интернет услуг явно не учитывалось наличие/отсутствие интрнета у клиентов, аналогично с телефонным соединением. Вопрос решен путем выделения дополнительного признака наличия телефонной связи и анализом признака типа интрнет соединения - при заполнении информации по всем клиентам в типе соединения добавлено третье значение - No. Подробное описание в разделе отчета "Набор данных".  
Ключевыми шагами в достижении целей проекта стали анализ, синтезирование и отбор признаков для моделей (с целью оптимальной настройки моделей) и интрепретация результатов (тонкая настройка порога классификации) с точки зрения бизнес-логики.

### Набор данных

**Оператор предоставляет два основных типа услуг:** 

1. Стационарную телефонную связь. Возможно подключение телефонного аппарата к нескольким линиям одновременно.
2. Интернет. Подключение может быть двух типов: через телефонную линию (DSL*,* от англ. *digital subscriber line*, «цифровая абонентская линия») или оптоволоконный кабель (*Fiber optic*).  

**Также доступны такие услуги:**
- Интернет-безопасность: антивирус (*DeviceProtection*) и блокировка небезопасных сайтов (*OnlineSecurity*);
- Выделенная линия технической поддержки (*TechSupport*);
- Облачное хранилище файлов для резервного копирования данных (*OnlineBackup*);
- Стриминговое телевидение (*StreamingTV*) и каталог фильмов (*StreamingMovies*).

За услуги клиенты могут платить каждый месяц или заключить договор на 1–2 года. Доступны различные способы расчёта и возможность получения электронного чека.

**Описание данных:**  
Данные состоят из файлов, полученных из разных источников:

- `contract.csv` — информация о договоре;
- `personal.csv` — персональные данные клиента;
- `internet.csv` — информация об интернет-услугах;
- `phone.csv` — информация об услугах телефонии.

Во всех файлах столбец `customerID` содержит код клиента.  
Информация о договорах актуальна на 1 февраля 2020.

Датафрейм **`contract`** содержит данные о контрактах с клиентами:
- месяце начала (разные года);
- месяце окончания (октябрь-декабрь 2019, январь 2020 года);
- типе оплаты (ежемесячно, за год, за два года);
- выставлении чеков (электронный чек или нет);
- методе оплаты (Electronic check, Mailed check, Bank transfer (automatic), Credit card (automatic)).  

Датафрейм **`internet`** содержит данные о:
- типе подключения к интернету - через телефонную линию (DSL*,* от англ. *digital subscriber line*, «цифровая абонентская линия») или оптоволоконный кабель (*Fiber optic*);
- подключенных клиентам интернет услугах:
 - Интернет-безопасность: антивирус (*DeviceProtection*) и блокировка небезопасных сайтов (*OnlineSecurity*);
 - Выделенная линия технической поддержки (*TechSupport*);
 - Облачное хранилище файлов для резервного копирования данных (*OnlineBackup*);
 - Стриминговое телевидение (*StreamingTV*) и каталог фильмов (*StreamingMovies*).   
 
Датафрейм **`personal`** содержит личные данные о всех клиентах компании:
- пол клиента;
- является ли пожилым человеком;
- имеет ли партнера / супруга;
- имеет ли иждивенцев.  

Датафрейм **`phone`** содержит данные о типе стационарной телефонной связи у клиентов - подключен ли телефонный аппарат к нескольким линиям одновременно.  

Целевым признаком в проекте будет служить информация о месяце окончания контракта из датафрейма **`contract`**. 1869 клиентов из 7043 (26,5%) ушли из компании.

**Предобработка данных:**

В данных нет дубликатов, однако есть отсутствующие значения - не все клиенты пользуются интернет подключением (и, соответственно, интрнет-услугами), не все клиенты имеют телефонное подключение, причем эти множества пересекаются.   
С одной стороны количество клиентов с интернет услугами и стационарной связью не равны общему количеству клиентов и кто не был перечислен в таблицах по виду услуг - однозначно их не имеет.   
С другой стороны, если просто заполнить пропущенные значения - так мы потеряем информацию о тех, кто не пользуется стационарной связью. В части интернета есть столбец InternetService, там два значения по видам канала, заполняя пропуски третьим значением (No), информацию о пользовании интернетом мы неявно сохраняем.   
Исходя из изложенного, добавлен бинарный признак - подключен ли стационарный телефон? По остальным столбцам пропуски заполнены значениями No.   

В ходе предобработки данных выполнены действия:
- информация о месяце окончания контракта преобразована в целевой признак и вынесена в отдельный столбец;
- столбец BeginDate приведен к формату даты, TotalCharges - к числовому; 
- столбец EndDate приведен к формату даты, отсутствующие даты заполнены датой 01.02.2020 (данные действительны на эту дату);
- создан столбец со сроком контракта в днях, как дополнительный признак, в том числе для исследовательского анализа данных.

### Метрики и  модели

Основная метрика проекта - ROC-AUC - ее использование максимизирует полноту выявления целевого класса, клиентов, склонных к уходу (True Positive Rate, Recall); и одновременно минимизирует ложные выявления клиентов, склонных к уходу, ложно положительных (False Positive Rate). Иными словами, это нормализованная вероятность того, что случайно взятый объект класса 1 (клиент, склонный к уходу) имеет оценку принадлежности к классу 1 выше, чем случайно взятый объект класса 0.

В целом, количество FalsePositive предсказаний не так важно для компании - если ложно положительным клиентам преложат промокоды и скидки, это скажется на выручке компании, но не так сильно, а работать на лояльность клиента будет все равно.

Для FalseNegative предсказания цена ошибки выше - это может повлечь уход клиента из компании и б***О***льшую потерю выручки. Поэтому, метрика ROC-AUC подходит. 

Как дополнительная, более интерпретируемая метрика, заказчиком предложена простая точность - доля правильно предсказанных клиентов обоих классов в общем числе клиентов (Accuracy). Точность имеет известные проблемы: нам важно, в связи с изложенной выше бизнес логикой, как можно более полно выявить клиентов, склонных к уходу. Поэтому, применительно к бизнес-задачам изучена дополнительная метрика Recall, которая показывает сколько клиентов, склонных к уходу, выявлено из общего количества клиентов, склонных к уходу. Дополнительные метрики изучены только в процессе тестирования.

В качестве основной модели использована модель градиентного бустинга CatBoostClassifier (хорошо зарекомендовавшая себя на практике для работы с табличными данными), в качестве альтернативной модели для сравнения - логистическая регрессия.

### Подготовка и отбор признаков

**Дисбаланс классов.**

Дисбаланс классов заметный (26,5% целевой класс в выборке), однако не критичный. Выбранная метрика ROC-AUC не чувствительна к дисбалансу классов, поскольку имеет вероятностную оценку. В нашей задаче (прогнозирование оттока), на самом деле нам нужна не «жёсткая» классификация (как различение кошек и собак по фото, например), а ранжирование: какие клиенты более склонны к уходу, чем другие? В этом случае, баланс классов вообще не важен, поскольку порог для принятия решений о классификации принимается на основе распределения предсказанных вероятностей отнесения к целевому классу.

В качестве основной модели предполагается использовать CatBoost, работающий на решающих деревьях, которые также нечувствительны к дисбалансу классов. Для этой модели дисбаланс классов не исправлялся.

Для логистической регрессии классы были сбалансированы, используя алгоритм SMOTE (синтетическая техника дублирования примеров миноритарного класса). SMOTE создаёт синтетические образцы вместо создания их копий - случайно выбирает одного из ближайших k-соседей и использует его для создания схожих, но случайно изменённых новых сведений. Также небходимо учитываать, что данных немного и бороться с дисбалансом классов уменьшением нецелевого класса нелогично.

**Стандартизация и кодирование.**

Для логистической регрессии выполнено кодирование OneHotEncoding, стандартизация - StandardScaler. Для модели CatBoost кодирование выполняет сама модель, а масштабирования числовых признаков деревья не требуют.

**Валидация и тестирование.**

Поскольку набор данных относительно небольшой - использована кросс-валидация с подбором гиперпараметров с помощью GridSearch. Размер тестовой выборки принят 25% от дата сета.

**Отбор признаков:**  

Из набора признаков удален заведомо ненужный для обучения столбец с ID клиента, столбец EndData, чтобы избежать утечки целевого признака, столбец BeginData, который заведомо будет коррелировать со сроком контракта в днях. При этом, дополнительно синтезирован признак Phone, отвечающий за информацию о наличии телефонного подключения, недоступную из других признаков после предобработки данных.   
С целью отбор признаков изучена корреляция остальных признаков, включая целевой, и сделаны следующие наблюдения:
1. Признак пола не коррелирует вообще ни с чем, в связи с чем удален.
2. Есть сильные корреляции между суммами месячной оплаты и общей оплаты с подключаемыми интернет услугами и наличием телефона. Все логично - чем больше услуг, очевидно, тем больше оплата. 
3. Сумма общей оплаты коррелирует также со сроком сотрудничества, что тоже логично.
5. Есть сильная корреляция между типом контракта и днями сотрудничества с клиентом. Очевидно, клиенты заключившие годовые или двухлетние контракты - дольше находятся в компании.
6. На целевой признак наибольшее влияние оказывают (топ-5):
- дни сотрудничества - 0.47;
- метод оплаты - 0.45;
- размер месячных платежей - 0.36;
- наличие интернета - 0.35;
- электронные счета - 0.30.

Мультиколлинеарности присутствует - TotalCharges и MonthlyCharges коррелируют со многими признаками (> 0.7). 

Для модели CatBoost это не критично, а для логистической регресии подготовлено два набора признаков - один как для CatBoost и, второй - за исключением TotalCharges и MonthlyCharges, исходя из логики, что получаемая выручка находится в зависимости от набора подключенных услуг и срока сотрудничества с клиентом, то есть эти признаки вторичны.

### Результаты

**Подбор гиперпараметров и выбор модели:**

**Логистическая регрессия** на выборке с полным набором признаков дала значение метрики ROC-AUC чуть выше (0,86), чем на наборе признаков, из которого удалены месячная и общая выручку, чтобы избежать мультиколлинеарности (0,85).  
Для **CatBoostClassifier** поиск лучших гиперпараметров проведен в несколько этапов. Для всех этапов была выбрана функция потерь Logloss и коэффицент обучения 0,1. Остальные переметры находились в следующих диапазонах (по этапас):
1. Глубина деревьев от 1 до 5 с шагом 1; количество от 900 до 1080 с шагом 20.
2. Глубина деревьев от 4 до 7 с шагом 1; количество от 1000 до 1350 с шагом 50.
3. Глубина деревьев от 1 до 3 с шагом 1; количество от 1800 до 2900 с шагом 100.
4. Глубина деревьев 2; количество от 2900 до 4900 с шагом 100.   
Отмечено, что количество итераций больше улучшает модель, чем глубина.

Лучшие результаты показала модель CatBoostClassifier с функцией потерь Logloss, коэффицентом обучения 0,1, глубиной деревьев 2, количеством 4500 - **лучшая метрика ROC-AUC составила 0.923**.

**Тестирование:**

На тестовой выборке значения метрик лучшей модели составили:
- ROC-AUC - 0.93
- Accuracy - 0.89
- Recall - 0.74

### Интерпретация результатов для максимизации выручки

Классификация по основной метрике ROC-AUC в среднем отнесла к первому классу клиентов с вероятностью выше 27,4%, это примерно соответствует доле целевого класса в выборке (26,5%). Так работает классификация с помощью выбранного инструмента sklearn roc_auc_score (оценки вероятности при классификации примерно соответствуют вероятности класса с большей меткой, класса 1). 

Вместе с тем, как отмечали выше, негативное влияние на выручку ухода клиента выше, чем негативное влияния преложения скидок. И хотя точность калссификации также высока - она касается предсказаний для обоих классов клиентов. Однако, главное для нас полнота выявления клиентов, склонных к уходу.

В работе выполнен подбор иного, ручного порога вероятности отнесения клиентов к целевому классу, выше которого следует считать клиентов склонными к уходу, исходя из максимизации выручки компании. Расчеты выполнены на основе матрицы ошибок для каждого порога (истинно-положительные, ложно-положительные, ложно-отрицательные и истинно-отрицательные предсказания). 

Расчет проведен на примере месячной выручки (ушедшие клиенты - средний чек 74 доллара, оставшиеся - 61 доллар в соответствии с историческими данными). **С целью дополнительного подтверждения указанной разницы проведено статистическое тестирование, которое показало, что вероятность случайной разницы в средних чеках на выборках крайне мала.**

С другой стороны, в расчет включено предложение скидок разного размера (5%, 10%, 20%, 50%) на месячный платеж всем клиентам, классифицированным как целевой класс:
1. Размер скидки 5%, наибольшая выручка - 113123.45, порог наибольшей выручки - 0.152602.
2. Размер скидки 10%, наибольшая выручка - 108546.9, порог наибольшей выручки - 0.152602.
3. Размер скидки 20%, наибольшая выручка - 99395.8, порог наибольшей выручки - 0.134607.
4. Размер скидки 50%, наибольшая выручка - 72157.5, порог наибольшей выручки - 0.087908.

Предлагается для данных расчетов с предложенными параметрами использовать в качестве промо предложение скидки в 5% или 10%. При этом скидки не нужно предлагать слишком большие - и 5% и 10% дает один и тот же порог и одно и тоже количество потенциально ушедших клиентов (полнота выявления), а выручка при 5% скидке выше. Разумеется, остается вопрос - какой размер скидки надежнее удержит клиента. 

При этом, с учетом расходов на удержание - скидки не нужно предлагать слишком многим, - значение Recall не максимальное, хотя и очень высокое (0,92). При этом, значение Accuracy (точности для обоих классов) снизилось - мы настроили порог так, что модель относит к целевому классу больше клиентов, в том числе не относящихся к нему. Однако, с точки зрения бизнеса такое значение оптимально.

Справочно, иллюстрация логики с точки зрения значения дополнительных интерпретируемых метрик. Изменения метрик в зависимости от значения порога:
1. Значение порога 0.01, ROC-AUC 0.93, Accuracy 0.45, Recall 0.99. Выявляем 99% целевого класса, однако точность для обоих классов очень низкая, а значит скидки буду предложены большому числу лояльных клиентов - значение выручки неоптимально.
2. Значение порога 0.152602, ROC-AUC 0.93, Accuracy 0.79, Recall 0.92. Выявляем 92% целевого класса, точность для обоих классов приемлема, значение выручки **оптимально**.
3. Значение порога 0.9, ROC-AUC 0.93, Accuracy 0.84, Recall 0.42. Выявляем всего 42% целевого класса, однако точность для обоих классов высокая, а значит скидки буду предложены меньшему числу лояльных клиентов. Однако, ушедших клиентов будет больше и больше негативного влияния на выручку - значение выручки неоптимально.

Подобные расчеты и настройка попрога вероятности классификации клиентов могут быть выполнены и для иных маркетинговых акций - предложения разовых промокодов, скидок на иной период (например, три месяца, в данном расчете - период скидок один месяц), бесплатную техподдержку или изменения типа подключения к интернету (при предоставлении дополнительных данных об исторических удельных расходах на предоставление указанных услуг), а также адаптированы под иную бизнес-логику.

### Интерпретация результатов для определения портрета клиента, склонного к уходу

**По результатм исследовательского анализа данных** получен нижеследующий портрет клиента, склонного к уходу на основании различий в долях по различным показателям среди ушедших и оставшихся клиентов.  

1. По личным данным клиентов:
- среди ушедших больше пожилых - 25%/13%;
- среди ушедших меньше имеющих иждивенцев - 17%/34%;
- среди ушедших меньше имеющих партнера - 36%/53%.
2. По подключенным услугам:
- среди ушедших больше пользователей интернета - 94%/73%;
- среди ушедших больше пользователей Fiber optic - 69%/35%;
- среди ушедших меньше пользователей DSL - 25%/38%;
- среди ушедших меньше пользующихся техподдержкой - 17%/34%;
- среди ушедших меньше пользующихся услугами блокировки нежелательного контента - 16%/33%;
- среди ушедших меньше пользующихся услугами бэкапа - 28%/37%;
- среди ушедших меньше пользующихся услугами антивируса - 29%/36%.
3. По типам контрактов и оплаты:
- среди ушедших больше платящих электронными чеками - 57%/25%, среди других видов оплаты - 12-16% по сравнению c 25% по другим типам у оставшихся клиентов;
- среди ушедших больше с месячным типом контракта - 89%/43%, годовой тип контракта - 9%/25%, двухлетний - 2,6%/32%;
- среди ушедших больше получающих электронные чеки - 75%/54%.
4. По суммам оплаты:
- среди ушедших чуть больше средняя месячная сумма оплаты - 74/61 долларов;
- среди ушедших средняя общая сумма оплаты намного меньше - 1532/2550 долларов.
5. По сроку сотрудничества с компанией: среди ушедших средний срок почти в два раза ниже - 547/1144 дней.

**По результатам влияния различных признаков на результат предсказания модели машинного обучения** наиболее важными признаками, влияющими на склонность к уходу, оказались (в порядке убывания):
- срок, проведенный в компании;
- размер ежемесячной оплаты;
- размер общей оплаты;
- тип контракта (месячный, годовой или двухлетний);
- тип и наличие интернет-соединения;
- метод оплаты;
- наличие электронного выставления счета.

Данные исследовательского анализа данных и анализ важности признаков модели согласуются между собой.  
**Таким образом, ушедшие клиенты харакеризуются следующими главными чертами** (в порядке убывания важности):
1. Меньше времени являлись клиентами, средний срок почти в два раза ниже - 547/1144 дней.
2. Платили больше (в среднем в месяц 74 доллара против 61 доллара).
3. Предпочитали месячный тип контракта - 89%/43%.
4. Больше пользовались интернетом - 94%/73%, в основном Fiber optic (69%/35%), при этом заметно меньше пользовались техподдержкой и другими интернет-услугами.
5. Больше платили электронными чеками - 57%/25%.
6. Больше получали электронные чеки - 75%/54%.